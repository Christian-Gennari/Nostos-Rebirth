<main class="layout-wrapper">

  <app-sidebar-collections />

  <div class="layout-content">
    <div class="container md">

      @if (loading()) {
      <div class="loading-state">Loading book details...</div>
      }

      @if (error()) {
      <div class="error-state">
        <lucide-icon [img]="AlertCircleIcon" [size]="32"
          style="margin-bottom: 1rem; color: var(--color-danger);"></lucide-icon>
        <p>{{ error() }}</p>
        <button class="btn btn-secondary" routerLink="/library">Return to Library</button>
      </div>
      }

      @if (!loading() && !error() && book()) {

      <div class="back-nav">
        <button class="btn-back" routerLink="/library">
          <lucide-icon [img]="ArrowLeftIcon" [size]="16"></lucide-icon>
          Back to Library
        </button>
      </div>

      <header class="book-header">

        <!-- If a cover exists -->
        @if (book()?.coverUrl) {

        <img [src]="book()?.coverUrl" alt="Book cover" class="detail-cover-image" />

        <div class="cover-actions">
          <button class="btn-secondary" (click)="triggerCoverPicker()">Change cover</button>
          <button class="btn-secondary danger" (click)="deleteCover()">Delete cover</button>
        </div>

        <input type="file" accept="image/*" #coverInput style="display:none" (change)="onCoverSelected($event)" />
        }

        <!-- If NO cover exists -->
        @else {

        <div class="cover-actions">
          <button class="btn-secondary" (click)="triggerCoverPicker()">Add cover</button>
        </div>

        <input type="file" accept="image/*" #coverInput style="display:none" (change)="onCoverSelected($event)" />
        }



        <h1>{{ book()?.title }}</h1>

        <div class="meta-row">
          <div class="meta-item">
            <lucide-icon [img]="UserIcon" [size]="16"></lucide-icon>
            <span>{{ book()?.author || 'Unknown Author' }}</span>
          </div>

          <div class="meta-item">
            <lucide-icon [img]="CalendarIcon" [size]="16"></lucide-icon>
            <span>Added recently</span>
          </div>
        </div>

        @if (book()?.hasFile) {
        <div class="header-actions">
          <button class="btn-file-action" (click)="openFile()">
            <lucide-icon [img]="BookOpenIcon" [size]="18"></lucide-icon>
            <span>Open File</span>
          </button>
        </div>
        } @else {
        <div class="header-actions">

          <p style="color: var(--color-text-light); font-size: 0.9rem; margin-bottom: 0.5rem;">
            No file uploaded
          </p>

          <button class="btn-file-action" (click)="triggerFilePicker()">
            <lucide-icon [img]="BookOpenIcon" [size]="18"></lucide-icon>
            <span>Upload File</span>
          </button>

          <input type="file" accept=".epub,.pdf,.txt" style="display:none" #fileInput
            (change)="onFileUploadSelected($event)" />
        </div>
        }
      </header>

      <section class="add-note-section">
        <div class="note-input-wrapper">
          <textarea class="note-textarea-seamless" placeholder="Jot down a thought, quote, or idea..."
            [(ngModel)]="newNote" rows="3">
            </textarea>

          @if (newNote().length > 0) {
          <div class="input-actions">
            <button class="btn btn-primary" (click)="addNote()">Add Note</button>
          </div>
          }
        </div>
      </section>

      <section class="notes-section">
        <h2>Notes ({{ notes().length }})</h2>

        @if (notes().length === 0) {
        <p style="color: var(--color-text-light); font-style: italic;">No notes yet. Start writing above.</p>
        }

        <ul class="notes-list">
          @for (note of notes(); track note.id) {
          <li class="note-item">

            @if (editingNote()?.id === note.id) {
            <div class="edit-wrapper">
              <textarea class="textarea" [(ngModel)]="editNoteContent" rows="3"></textarea>
              <div class="edit-actions">
                <button class="btn btn-primary" (click)="saveEdit()">Save Update</button>
                <button class="btn btn-secondary" (click)="cancelEdit()">Cancel</button>
              </div>
            </div>
            }
            @else {
            <div class="note-card">
              <p class="note-content">{{ note.content }}</p>

              <div class="note-actions">
                <button class="icon-btn bordered" (click)="startEdit(note)" title="Edit">
                  <lucide-icon [img]="Edit2Icon" [size]="14"></lucide-icon>
                </button>
                <button class="icon-btn bordered delete" (click)="deleteNote(note.id)" title="Delete">
                  <lucide-icon [img]="Trash2Icon" [size]="14"></lucide-icon>
                </button>
              </div>
            </div>
            }

          </li>
          }
        </ul>
      </section>

      }

    </div>
  </div>
</main>
