<main class="layout-wrapper">
  <div class="layout-content">
    <div class="container md">
      @if (loading()) {
      <div class="back-nav">
        <div class="skeleton-line" style="width: 100px; height: 20px"></div>
      </div>
      <div class="detail-grid">
        <aside class="detail-cover-col">
          <div class="skeleton-box cover-size"></div>
        </aside>
        <section class="detail-info-col">
          <div class="skeleton-line title"></div>
          <div class="skeleton-line author"></div>
          <div class="skeleton-block"></div>
        </section>
      </div>
      } @if (error()) {
      <div class="error-state">
        <lucide-icon
          [img]="AlertCircleIcon"
          [size]="32"
          style="margin-bottom: 1rem; color: var(--color-danger)"
        ></lucide-icon>
        <p>{{ error() }}</p>
        <button class="btn btn-secondary" routerLink="/library">Return to Library</button>
      </div>
      } @if (!loading() && !error() && book()) {

      <div class="back-nav">
        <button class="btn-back" routerLink="/library">
          <lucide-icon [img]="ArrowLeftIcon" [size]="16"></lucide-icon>
          <span>Library</span>
        </button>
      </div>

      <div class="detail-grid">
        <aside class="detail-cover-col">
          <div class="cover-frame">
            @if (book()?.coverUrl) {
            <img [src]="book()?.coverUrl" alt="Book cover" class="cover-img" />
            } @else {
            <div class="placeholder-cover">
              <lucide-icon
                [img]="BookOpenIcon"
                [size]="48"
                strokeWidth="1"
                color="#ccc"
              ></lucide-icon>
            </div>
            }
          </div>

          <div class="cover-actions-links">
            <button class="btn btn-secondary" style="width: 100%" (click)="openMetadataModal()">
              <lucide-icon [img]="Edit2Icon" [size]="16"></lucide-icon>
              Edit Metadata
            </button>

            <div class="cover-controls">
              <button
                id="uploadorChangeCover"
                class="btn btn-xs btn-ghost"
                (click)="triggerCoverPicker()"
              >
                <lucide-icon [img]="ImageIcon" [size]="14"></lucide-icon>
                {{ book()?.coverUrl ? 'Change' : 'Upload' }}
              </button>

              @if (book()?.coverUrl) {
              <div class="vertical-divider"></div>
              <button id="removeCover" class="btn btn-xs btn-ghost danger" (click)="deleteCover()">
                Remove
              </button>
              }
            </div>
          </div>
          <input
            type="file"
            accept="image/*"
            #coverInput
            style="display: none"
            (change)="onCoverSelected($event)"
          />
        </aside>

        <section class="detail-info-col">
          <header class="info-header">
            <div class="header-top-row">
              <h1 class="book-title">{{ book()?.title }}</h1>
              <button
                class="btn-icon favorite-btn desktop-fav"
                [class.active]="book()?.isFavorite"
                (click)="toggleFavorite()"
                title="Toggle Favorite"
              >
                <lucide-icon
                  [img]="HeartIcon"
                  [size]="24"
                  [class.filled]="book()?.isFavorite"
                ></lucide-icon>
              </button>
            </div>

            @if (book()?.subtitle) {
            <h3 class="book-subtitle">{{ book()?.subtitle }}</h3>
            }

            <h2 class="book-author">{{ book()?.author || 'Unknown Author' }}</h2>

            @if (book()?.editor) {
            <div class="book-contributor">Edited by {{ book()?.editor }}</div>
            } @if (book()?.translator) {
            <div class="book-contributor">Translated by {{ book()?.translator }}</div>
            }

            <div class="user-metadata-row">
              <app-star-rating
                [rating]="book()?.rating || 0"
                [size]="20"
                (ratingChange)="onRate($event)"
              ></app-star-rating>

              <div class="vertical-divider"></div>

              <button
                class="btn-icon finish-toggle-btn"
                [class.active]="book()?.finishedAt"
                (click)="toggleFinished()"
                [title]="book()?.finishedAt ? 'Mark as Unread' : 'Mark as Read'"
              >
                <lucide-icon
                  [img]="CheckCircleIcon"
                  [size]="20"
                  [class.filled]="book()?.finishedAt"
                ></lucide-icon>
              </button>

              <button
                class="btn-icon favorite-btn mobile-fav"
                [class.active]="book()?.isFavorite"
                (click)="toggleFavorite()"
                title="Toggle Favorite"
                style="margin-top: 0"
              >
                <lucide-icon
                  [img]="HeartIcon"
                  [size]="24"
                  [class.filled]="book()?.isFavorite"
                ></lucide-icon>
              </button>
            </div>

            <div class="primary-actions">
              @if (book()?.hasFile) {
              <button class="btn btn-secondary" (click)="downloadFile()">
                <lucide-icon [img]="BookDownIcon" [size]="18"></lucide-icon>
                <span>Download File</span>
              </button>

              @if (isAudioBook(book())) {
              <button class="btn btn-primary" (click)="openReader()">
                <lucide-icon [img]="HeadphonesIcon" [size]="18"></lucide-icon>
                <span>Listen</span>
              </button>
              } @else {
              <button class="btn btn-primary" (click)="openReader()">
                <lucide-icon [img]="BookOpenIcon" [size]="18"></lucide-icon>
                <span>Read Book</span>
              </button>
              } } @else {
              <button class="btn btn-primary" (click)="triggerFilePicker()">
                <lucide-icon [img]="BookOpenIcon" [size]="18"></lucide-icon>
                <span>Upload File</span>
              </button>
              }
              <input
                type="file"
                accept=".epub,.pdf,.txt,.mobi,.mp3,.m4a,.m4b"
                style="display: none"
                #fileInput
                (change)="onFileUploadSelected($event)"
              />
            </div>
          </header>

          <div class="synopsis-metadata-block" [class.expanded]="isDescriptionExpanded()">
            @if (book()?.personalReview) {
            <div class="personal-review">
              <div class="review-label">
                <lucide-icon [img]="QuoteIcon" [size]="14"></lucide-icon> My Review
              </div>
              <p class="review-text">{{ book()?.personalReview }}</p>
            </div>
            }

            <div class="synopsis-content">
              <h4>Synopsis</h4>
              @if (book()?.description) {
              <p class="description-text">{{ book()?.description }}</p>

              @if (!isDescriptionExpanded()) {
              <div class="fade-overlay"></div>
              } } @else {
              <p class="description-placeholder">No description added.</p>
              }
            </div>

            @if (book()?.description) {
            <button class="expand-btn" (click)="toggleDescription()">
              {{ isDescriptionExpanded() ? 'Show Less' : 'Read More' }}
              <span class="icon">{{ isDescriptionExpanded() ? '↑' : '↓' }}</span>
            </button>
            }

            <div class="meta-grid">
              @if (book()?.series) {
              <div class="meta-item full-width">
                <span class="label">Series</span>
                <span class="value">
                  {{ book()?.series }} {{ book()?.volumeNumber ? '#' + book()?.volumeNumber : '' }}
                </span>
              </div>
              } @if (isAudioBook(book()) && book()?.narrator) {
              <div class="meta-item full-width">
                <span class="label"
                  ><lucide-icon [img]="MicIcon" [size]="12"></lucide-icon> Narrator</span
                >
                <span class="value">{{ book()?.narrator }}</span>
              </div>
              }
              <div class="meta-item">
                <span class="label">
                  @if (isAudioBook(book())) {
                  <lucide-icon [img]="ClockIcon" [size]="12"></lucide-icon> Duration } @else {
                  <lucide-icon [img]="LayersIcon" [size]="12"></lucide-icon> Pages }
                </span>
                <span class="value">
                  {{ (isAudioBook(book()) ? book()?.duration : book()?.pageCount) || '—' }}
                </span>
              </div>

              <div class="meta-item">
                <span class="label"
                  ><lucide-icon [img]="CalendarIcon" [size]="12"></lucide-icon> Published</span
                >
                <span class="value">{{ book()?.publishedDate || '—' }}</span>
              </div>

              <div class="meta-item">
                <span class="label"
                  ><lucide-icon [img]="BuildingIcon" [size]="12"></lucide-icon> Publisher</span
                >
                <span class="value">{{ book()?.publisher || '—' }}</span>
              </div>

              <div class="meta-item">
                <span class="label"
                  ><lucide-icon [img]="MapPinIcon" [size]="12"></lucide-icon> Location</span
                >
                <span class="value">{{ book()?.placeOfPublication || '—' }}</span>
              </div>

              <div class="meta-item">
                <span class="label">Edition</span>
                <span class="value">{{ book()?.edition || '—' }}</span>
              </div>

              <div class="meta-item">
                <span class="label"
                  ><lucide-icon [img]="HashIcon" [size]="12"></lucide-icon>
                  {{ isAudioBook(book()) ? 'ASIN' : 'ISBN' }}
                </span>
                <span class="value">
                  {{ (isAudioBook(book()) ? book()?.asin : book()?.isbn) || '—' }}
                </span>
              </div>

              <div class="meta-item">
                <span class="label">Language</span>
                <span class="value">{{ book()?.language || '—' | uppercase }}</span>
              </div>

              @if(book()?.categories) {
              <div class="meta-item full-width">
                <span class="label">Genres</span>
                <div class="value" style="display: flex; gap: 0.5rem; flex-wrap: wrap">
                  @for(cat of book()?.categories?.split(','); track cat) {
                  <span class="tag">{{ cat.trim() }}</span>
                  }
                </div>
              </div>
              } @if(book()?.collectionId) {
              <div class="meta-item full-width">
                <span class="label">Collection</span>
                <span class="value">
                  {{ getCollectionName(book()?.collectionId) }}
                </span>
              </div>
              }
            </div>
          </div>

          <hr class="divider" />

          <div class="notes-container">
            <div class="notes-header">
              <h3>Personal Notes</h3>
              <span class="badge-count">{{ notes().length }}</span>
            </div>

            <div class="new-note-box">
              <app-concept-input
                placeholder="Jot down a thought..."
                [(ngModel)]="newNote"
                [rows]="1"
                (submitTrigger)="addNote()"
              ></app-concept-input>

              @if (newNote().length > 0) {
              <button class="btn btn-primary btn-sm" (click)="addNote()">Save</button>
              }
            </div>

            <div class="notes-feed">
              @for (note of notes(); track note.id) {
              <app-note-card
                [note]="note"
                [conceptMap]="conceptMap()"
                (update)="onUpdateNote($event)"
                (delete)="onDeleteNote($event)"
                (conceptClick)="onConceptClick($event)"
              ></app-note-card>
              }
            </div>
          </div>
        </section>
      </div>
      }
    </div>
  </div>

  <app-add-book-modal
    [isOpen]="showMetadataModal()"
    [book]="book()!"
    [collections]="collections()"
    (closeModal)="closeMetadataModal()"
    (bookUpdated)="onBookUpdated($event)"
  >
  </app-add-book-modal>
</main>
