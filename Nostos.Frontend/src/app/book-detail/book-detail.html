<main class="layout-wrapper">

  <div class="layout-content">
    <div class="container md">

      @if (loading()) {
      <div class="back-nav">
        <div class="skeleton-line" style="width: 100px; height: 20px;"></div>
      </div>

      <div class="detail-grid">
        <aside class="detail-cover-col">
          <div class="skeleton-box cover-size"></div>
          <div class="skeleton-line" style="width: 80px; margin-top: 1rem; height: 14px;"></div>
        </aside>

        <section class="detail-info-col">
          <div class="skeleton-line title"></div>
          <div class="skeleton-line author"></div>
          <div style="display:flex; gap:1rem; margin-bottom: 2rem;">
            <div class="skeleton-line tags"></div>
            <div class="skeleton-line tags"></div>
          </div>
          <div class="skeleton-line" style="width: 140px; height: 40px;"></div>
          <hr class="divider" style="opacity: 0.3;" />
          <div class="skeleton-block"></div>
        </section>
      </div>
      }

      @if (error()) {
      <div class="error-state">
        <lucide-icon [img]="AlertCircleIcon" [size]="32"
          style="margin-bottom: 1rem; color: var(--color-danger);"></lucide-icon>
        <p>{{ error() }}</p>
        <button class="btn btn-secondary" routerLink="/library">Return to Library</button>
      </div>
      }

      @if (!loading() && !error() && book()) {

      <div class="back-nav">
        <button class="btn-back" routerLink="/library">
          <lucide-icon [img]="ArrowLeftIcon" [size]="16"></lucide-icon>
          <span>Library</span>
        </button>
      </div>

      <div class="detail-grid">

        <aside class="detail-cover-col">
          <div class="cover-frame">
            @if (book()?.coverUrl) {
            <img [src]="book()?.coverUrl" alt="Book cover" class="cover-img" />
            } @else {
            <div class="placeholder-cover">
              <lucide-icon [img]="BookOpenIcon" [size]="48" strokeWidth="1" color="#ccc"></lucide-icon>
            </div>
            }
          </div>

          <div class="cover-actions-links">
            <button class="link-btn" (click)="openMetadataModal()">Edit Metadata</button>

            <span class="sep">•</span>

            <button class="link-btn" (click)="triggerCoverPicker()">
              {{ book()?.coverUrl ? 'Change Cover' : 'Upload Cover' }}
            </button>

            @if (book()?.coverUrl) {
            <span class="sep">•</span>
            <button class="link-btn danger" (click)="deleteCover()">Remove Cover</button>
            }
          </div>
          <input type="file" accept="image/*" #coverInput style="display:none" (change)="onCoverSelected($event)" />
        </aside>


        <section class="detail-info-col">

          <header class="info-header">
            <h1 class="book-title">{{ book()?.title }}</h1>
            <h2 class="book-author">{{ book()?.author || 'Unknown Author' }}</h2>

            <div class="meta-tags">
              <span class="tag">
                <lucide-icon [img]="CalendarIcon" [size]="14"></lucide-icon>
                Added Nov 26
              </span>
              @if (book()?.hasFile) {
              <span class="tag success">
                <lucide-icon [img]="CheckIcon" [size]="14"></lucide-icon>
                File Available
              </span>
              }
            </div>

            <div class="primary-actions">

              @if (book()?.hasFile) {
              <button class="btn btn-primary" (click)="openFile()">
                <lucide-icon [img]="BookOpenIcon" [size]="18"></lucide-icon>
                <span>Read Book</span>
              </button>
              } @else {
              <button class="btn btn-primary" (click)="triggerFilePicker()">
                <lucide-icon [img]="BookOpenIcon" [size]="18"></lucide-icon>
                <span>Upload EPUB/PDF</span>
              </button>
              }
              <input type="file" accept=".epub,.pdf,.txt" style="display:none" #fileInput
                (change)="onFileUploadSelected($event)" />
            </div>
          </header>

          <hr class="divider" />

          <div class="notes-container">
            <div class="notes-header">
              <h3>Personal Notes</h3>
              <span class="count">{{ notes().length }}</span>
            </div>

            <div class="new-note-box">
              <textarea class="note-input" placeholder="Jot down a thought..." [(ngModel)]="newNote"
                rows="1"></textarea>
              @if (newNote().length > 0) {
              <button class="btn btn-primary btn-sm" (click)="addNote()">Save</button>
              }
            </div>

            <div class="notes-feed">
              @for (note of notes(); track note.id) {
              <div class="note-row" (click)="handleNoteClick($event)">
                @if (editingNote()?.id === note.id) {
                <div class="edit-box">
                  <textarea class="note-input" [(ngModel)]="editNoteContent" rows="3"></textarea>
                  <div class="row-actions">
                    <button class="link-btn" (click)="saveEdit()">Save</button>
                    <button class="link-btn" (click)="cancelEdit()">Cancel</button>
                  </div>
                </div>
                } @else {

                <p class="note-text whitespace-pre-wrap" [innerHTML]="formatNote(note.content)"></p>
                <div class="note-hover-actions">
                  <button class="icon-btn xs" (click)="startEdit(note); $event.stopPropagation();"><lucide-icon
                      [img]="Edit2Icon" [size]="14"></lucide-icon></button>
                  <button class="icon-btn xs delete"
                    (click)="deleteNote(note.id); $event.stopPropagation();"><lucide-icon [img]="Trash2Icon"
                      [size]="14"></lucide-icon></button>
                </div>
                }
              </div>
              }
            </div>
          </div>

        </section>

      </div>
      }

    </div>
  </div>

  @if (showMetadataModal()) {
  <div class="modal-overlay" (click)="closeMetadataModal()"
    style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px);">

    <div class="modal-content" (click)="$event.stopPropagation()"
      style="background: var(--bg-surface); padding: 1.5rem; border-radius: var(--radius-lg); width: 100%; max-width: 500px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);">

      <h3 style="margin-bottom: 1.5rem; font-size: 1.25rem; font-family: 'Lora', serif; color: var(--color-primary);">
        Edit Metadata</h3>

      <div class="form-stack" style="display: flex; flex-direction: column; gap: 1rem;">

        <div>
          <label
            style="display:block; font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: 0.4rem;">Title</label>
          <input class="input" [(ngModel)]="metaForm.title" />
        </div>

        <div>
          <label
            style="display:block; font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: 0.4rem;">Author</label>
          <input class="input" [(ngModel)]="metaForm.author" />
        </div>

        <div>
          <label
            style="display:block; font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: 0.4rem;">Collection</label>
          <div style="position: relative;">
            <select [(ngModel)]="metaForm.collectionId" class="input" style="appearance: none; cursor: pointer;">
              <option [ngValue]="null">No Collection</option>
              <option *ngFor="let col of collections()" [value]="col.id">{{ col.name }}</option>
            </select>
            <div
              style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--color-text-light);">
              <lucide-icon [img]="ChevronDownIcon" [size]="16"></lucide-icon>
            </div>
          </div>
        </div>

      </div>

      <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 2rem;">
        <button class="btn btn-secondary" (click)="closeMetadataModal()">Cancel</button>
        <button class="btn btn-primary" (click)="saveMetadata()">Save Changes</button>
      </div>
    </div>
  </div>
  }

</main>
