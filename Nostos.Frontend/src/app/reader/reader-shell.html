<div class="reader-layout" [class.ready]="ready()">
  <div class="reader-body">
    <main class="reader-content">
      @if (loading()) {
      <div class="loading">Loading book...</div>
      } @else { @switch (fileType()) { @case ('pdf') {
      <app-pdf-reader [bookId]="book()!.id" (noteCreated)="handleNoteCreated()" />
      } @case ('epub') {
      <app-epub-reader [bookId]="book()!.id" (noteCreated)="handleNoteCreated()" />
      } @case ('audio') {
      <app-audio-reader [bookId]="book()!.id" />
      } @default {
      <div class="error">Unsupported file format.</div>
      } } }
    </main>

    <aside class="toc-panel" [class.open]="tocOpen()">
      <div class="panel-header">
        <h3>Table of Contents</h3>
        <button class="icon-btn" (click)="toggleToc()">
          <lucide-icon [img]="Icons.Close" [size]="20"></lucide-icon>
        </button>
      </div>
      <div class="toc-list">
        @for (item of toc(); track $index) {
        <div class="toc-item" (click)="handleTocClick(item)">
          {{ item.label }}
        </div>
        } @empty {
        <div class="empty-state">No Table of Contents available.</div>
        }
      </div>
    </aside>

    <aside class="notes-panel" [class.collapsed]="!notesOpen()">
      <div class="notes-header">
        <h3>Notes & Highlights</h3>
        <button class="icon-btn" (click)="toggleNotes()">
          <lucide-icon [img]="Icons.Close" [size]="20"></lucide-icon>
        </button>
      </div>

      <div class="quick-note">
        <div class="input-wrapper">
          <textarea
            [(ngModel)]="quickNoteContent"
            placeholder="Add a quick note..."
            rows="2"
          ></textarea>
        </div>
        <div class="quick-actions">
          @if (fileType() === 'audio') {
          <button class="text-btn small" (click)="addAudioTimestamp()">
            <lucide-icon [img]="Icons.Clock" [size]="14"></lucide-icon> Timestamp
          </button>
          }
          <button
            class="btn-primary small"
            (click)="saveQuickNote()"
            [disabled]="!quickNoteContent()"
          >
            Save
          </button>
        </div>
      </div>

      <div class="notes-list">
        @for (note of dbNotes(); track note.id) {
        <div
          class="note-card"
          (click)="jumpToNote(note)"
          [class.editing]="editingNoteId() === note.id"
        >
          @if (note.selectedText) {
          <div class="note-quote">
            <lucide-icon
              [img]="Icons.MessageSquareQuote"
              [size]="14"
              class="quote-icon"
            ></lucide-icon>
            <p>"{{ note.selectedText }}"</p>
          </div>
          } @if (editingNoteId() === note.id) {
          <div class="edit-box" (click)="$event.stopPropagation()">
            <textarea [(ngModel)]="editContent" rows="3"></textarea>
            <div class="edit-actions">
              <button class="icon-btn small" (click)="saveEdit(note, $event)">
                <lucide-icon [img]="Icons.Check" [size]="16"></lucide-icon>
              </button>
              <button class="icon-btn small" (click)="cancelEdit($event)">
                <lucide-icon [img]="Icons.Close" [size]="16"></lucide-icon>
              </button>
            </div>
          </div>
          } @else { @if (note.content) {
          <div class="note-content">
            {{ note.content }}
          </div>
          } @else {
          <div class="note-content placeholder">No additional comment.</div>
          } }

          <div class="note-footer">
            <span class="note-date">{{ note.createdAt | date : 'short' }}</span>
            <div class="note-actions">
              <button class="icon-btn xs" (click)="startEdit(note, $event)">
                <lucide-icon [img]="Icons.Edit" [size]="14"></lucide-icon>
              </button>
              <button class="icon-btn xs delete" (click)="deleteNote(note.id, $event)">
                <lucide-icon [img]="Icons.Delete" [size]="14"></lucide-icon>
              </button>
            </div>
          </div>
        </div>
        } @empty {
        <div class="empty-state">
          <lucide-icon [img]="Icons.StickyNote" [size]="48"></lucide-icon>
          <p>No notes yet.</p>
          <small>Highlight text or use the box above to add one.</small>
        </div>
        }
      </div>
    </aside>
  </div>

  <header class="reader-toolbar">
    <div class="toolbar-left">
      <button class="icon-btn" (click)="goBack()">
        <lucide-icon [img]="Icons.ArrowLeft" [size]="20"></lucide-icon>
      </button>
      <button class="icon-btn" (click)="toggleToc()" title="Table of Contents">
        <lucide-icon [img]="Icons.List" [size]="20"></lucide-icon>
      </button>
    </div>

    <div class="toolbar-center">
      <button class="icon-btn" (click)="prevPage()" title="Previous">
        <lucide-icon [img]="Icons.Prev" [size]="20"></lucide-icon>
      </button>

      <div class="progress-display">
        <span>{{ progressLabel() }}</span>
      </div>

      <button class="icon-btn" (click)="nextPage()" title="Next">
        <lucide-icon [img]="Icons.Next" [size]="20"></lucide-icon>
      </button>
    </div>

    <div class="toolbar-right">
      @if (fileType() !== 'audio') {
      <button class="icon-btn" (click)="zoomOut()">
        <lucide-icon [img]="Icons.ZoomOut" [size]="20"></lucide-icon>
      </button>
      <button class="icon-btn" (click)="zoomIn()">
        <lucide-icon [img]="Icons.ZoomIn" [size]="20"></lucide-icon>
      </button>
      }
      <button class="icon-btn" (click)="toggleNotes()" [class.active]="notesOpen()">
        <lucide-icon [img]="Icons.NotebookPen" [size]="20"></lucide-icon>
      </button>
    </div>
  </header>
</div>
