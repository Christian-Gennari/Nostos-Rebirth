<div class="reader-layout" [class.ready]="ready()">
  <div class="reader-body">
    <main class="reader-content">
      @if (loading()) {
      <div class="loading">Loading book...</div>
      } @else { @switch (fileType()) { @case ('pdf') {
      <app-pdf-reader
        [bookId]="book()!.id"
        [initialLocation]="book()?.lastLocation"
        [sidebarVisible]="tocOpen()"
        (sidebarVisibleChange)="tocOpen.set($event)"
        (noteCreated)="handleNoteCreated()"
      />
      } @case ('epub') {
      <app-epub-reader [bookId]="book()!.id" (noteCreated)="handleNoteCreated()" />
      } @case ('audio') {
      <app-audio-reader [bookId]="book()!.id" />
      } @default {
      <div class="error">Unsupported file format.</div>
      } } }
    </main>

    <aside class="toc-panel" [class.open]="tocOpen() && fileType() !== 'pdf'">
      <div class="panel-header">
        <h3>Table of Contents</h3>
        <button class="icon-btn" (click)="toggleToc()">
          <lucide-icon [img]="Icons.Close" [size]="20"></lucide-icon>
        </button>
      </div>

      <div class="toc-list">
        <ng-template #tocTemplate let-items>
          @for (item of items; track $index) {
          <div class="toc-item-wrapper">
            <div class="toc-item" (click)="handleTocClick(item)">
              {{ item.label }}
            </div>

            @if (item.children && item.children.length > 0) {
            <div class="toc-subitems">
              <ng-container
                *ngTemplateOutlet="tocTemplate; context: { $implicit: item.children }"
              ></ng-container>
            </div>
            }
          </div>
          }
        </ng-template>

        <ng-container *ngTemplateOutlet="tocTemplate; context: { $implicit: toc() }"></ng-container>

        @if (toc().length === 0) {
        <div class="empty-state">No Table of Contents available.</div>
        }
      </div>
    </aside>

    <aside class="notes-panel" [class.open]="notesOpen()">
      <div class="notes-header">
        <h3>Notes & Highlights</h3>
        <button class="icon-btn" (click)="toggleNotes()">
          <lucide-icon [img]="Icons.Close" [size]="20"></lucide-icon>
        </button>
      </div>

      <div class="quick-note">
        <div class="input-wrapper">
          <app-concept-input
            [(ngModel)]="quickNoteContent"
            placeholder="Add a quick note..."
            [rows]="2"
            (submitTrigger)="saveQuickNote()"
          ></app-concept-input>
        </div>
        <div class="quick-actions">
          @if (fileType() === 'audio') {
          <button class="btn btn-secondary" (click)="addAudioTimestamp()">
            <lucide-icon id="add-timestamp-icon" [img]="Icons.Clock" [size]="14"></lucide-icon>
            Timestamp
          </button>
          }
          <button
            class="btn btn-primary"
            (click)="saveQuickNote()"
            [disabled]="!quickNoteContent()"
          >
            Save
          </button>
        </div>
      </div>

      <div class="notes-list">
        @for (note of dbNotes(); track note.id) {
        <app-note-card
          [note]="note"
          [conceptMap]="conceptMap()"
          [showNavigation]="true"
          (update)="onUpdateNote($event)"
          (delete)="onDeleteNote($event)"
          (cardClick)="onJumpToNote(note)"
        ></app-note-card>
        } @empty {
        <div class="empty-state">
          <lucide-icon [img]="Icons.StickyNote" [size]="48"></lucide-icon>
          <p>No notes yet.</p>
          <small>Highlight text or use the box above to add one.</small>
        </div>
        }
      </div>
    </aside>
  </div>

  <header class="reader-toolbar">
    <div class="toolbar-left">
      <button class="icon-btn" (click)="goBack()">
        <lucide-icon [img]="Icons.ArrowLeft" [size]="20"></lucide-icon>
      </button>
      <button class="icon-btn" (click)="toggleToc()" title="Table of Contents">
        <lucide-icon [img]="Icons.List" [size]="20"></lucide-icon>
      </button>
    </div>

    <div class="toolbar-center">
      @if (fileType() !== 'audio') {
      <button class="icon-btn" (click)="prevPage()" title="Previous">
        <lucide-icon [img]="Icons.Prev" [size]="20"></lucide-icon>
      </button>

      <div class="progress-display">
        @if (progressState()?.pageNumber) {
        <div class="page-navigation">
          <input
            type="number"
            class="page-input"
            [value]="progressState()?.pageNumber"
            (keyup.enter)="onPageInput($event)"
          />
          <span class="total-pages"> / {{ progressState()?.pageCount }}</span>
        </div>
        } @else {
        <span>{{ progressLabel() }}</span>
        } @if (progressTooltip()) {
        <div class="info-tooltip">
          <lucide-icon [img]="Icons.Info" [size]="14"></lucide-icon>
          <span class="tooltip-text">{{ progressTooltip() }}</span>
        </div>
        }
      </div>

      <button class="icon-btn" (click)="nextPage()" title="Next">
        <lucide-icon [img]="Icons.Next" [size]="20"></lucide-icon>
      </button>
      }
    </div>

    <div class="toolbar-right">
      @if (fileType() !== 'audio') {
      <button class="icon-btn desktop-only" (click)="zoomOut()">
        <lucide-icon [img]="Icons.ZoomOut" [size]="20"></lucide-icon>
      </button>
      <button class="icon-btn desktop-only" (click)="zoomIn()">
        <lucide-icon [img]="Icons.ZoomIn" [size]="20"></lucide-icon>
      </button>
      }
      <button class="icon-btn" (click)="toggleNotes()" [class.active]="notesOpen()">
        <lucide-icon [img]="Icons.NotebookPen" [size]="20"></lucide-icon>
      </button>
    </div>
  </header>
</div>
