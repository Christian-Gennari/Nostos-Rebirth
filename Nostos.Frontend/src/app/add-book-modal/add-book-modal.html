@if (isOpen()) {
<div class="modal-backdrop" (click)="closeModal.emit()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h2>{{ isEditMode() ? 'Edit Metadata' : 'Add New Book' }}</h2>
      <button class="icon-btn" (click)="closeModal.emit()" title="Close">
        <lucide-icon [img]="XIcon" [size]="20"></lucide-icon>
      </button>
    </header>

    <div class="modal-tabs">
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'General'"
        (click)="setTab('General')"
      >
        <lucide-icon [img]="GeneralIcon" [size]="16"></lucide-icon> General
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'Metadata'"
        (click)="setTab('Metadata')"
      >
        <lucide-icon [img]="MetadataIcon" [size]="16"></lucide-icon> Details
      </button>
      <button class="tab-btn" [class.active]="activeTab() === 'File'" (click)="setTab('File')">
        <lucide-icon [img]="FileIcon" [size]="16"></lucide-icon> File & ID
      </button>
    </div>

    <div class="modal-body">
      <form (ngSubmit)="submit()" #bookForm="ngForm">
        @if (activeTab() === 'General') {
        <div class="tab-content fade-in">
          <div class="form-group">
            <label class="form-label">Title <span class="required">*</span></label>
            <input
              class="input"
              type="text"
              [(ngModel)]="form.title"
              name="title"
              required
              placeholder="Book Title"
            />
          </div>

          <div class="form-group">
            <label class="form-label">Subtitle</label>
            <input
              class="input"
              type="text"
              [(ngModel)]="form.subtitle"
              name="subtitle"
              placeholder="Subtitle"
            />
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">Author</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="form.author"
                name="author"
                placeholder="Author"
              />
            </div>
            <div class="form-group">
              <label class="form-label">Translator</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="form.translator"
                name="translator"
                placeholder="Translator (Optional)"
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea
              class="input textarea"
              rows="5"
              [(ngModel)]="form.description"
              name="description"
            ></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Collection</label>
            <select [(ngModel)]="form.collectionId" name="collectionId" class="select-input input">
              <option [ngValue]="null">None</option>
              @for (col of collections(); track col.id) {
              <option [value]="col.id">{{ col.name }}</option>
              }
            </select>
          </div>
        </div>
        } @if (activeTab() === 'Metadata') {
        <div class="tab-content fade-in">
          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">Series</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="form.series"
                name="series"
                placeholder="Series Name"
              />
            </div>
            <div class="form-group">
              <label class="form-label">Volume #</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="form.volumeNumber"
                name="volumeNumber"
                placeholder="e.g. 1"
              />
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">Publisher</label>
              <input class="input" type="text" [(ngModel)]="form.publisher" name="publisher" />
            </div>
            <div class="form-group">
              <label class="form-label">Edition</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="form.edition"
                name="edition"
                placeholder="e.g. 2nd"
              />
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">Published Date</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="form.publishedDate"
                name="publishedDate"
                placeholder="YYYY or YYYY-MM-DD"
              />
            </div>
            <div class="form-group">
              <label class="form-label">Language</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="form.language"
                name="language"
                placeholder="en"
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Genres</label>
            <input
              class="input"
              type="text"
              [(ngModel)]="form.categories"
              name="categories"
              placeholder="Fiction, Sci-Fi..."
            />
          </div>
        </div>
        } @if (activeTab() === 'File') {
        <div class="tab-content fade-in">
          <div class="form-group">
            <label class="form-label">Format</label>
            <select
              [(ngModel)]="form.type"
              name="type"
              class="select-input input"
              [disabled]="isEditMode()"
            >
              <option value="physical">Physical Book</option>
              <option value="ebook">E-Book</option>
              <option value="audiobook">Audiobook</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label"
              >{{ form.type === 'audiobook' ? 'ASIN' : 'ISBN' }} (Fetchable)</label
            >
            <div class="input-group-fetch">
              @if (form.type === 'audiobook') {
              <input
                class="input"
                type="text"
                [(ngModel)]="form.asin"
                name="asin"
                placeholder="ASIN (e.g. B00...)"
              />
              } @else {
              <input
                class="input"
                type="text"
                [(ngModel)]="form.isbn"
                name="isbn"
                placeholder="ISBN"
                (keydown.enter)="$event.preventDefault(); fetchMetadata()"
              />
              <button
                type="button"
                class="btn btn-secondary btn-fetch"
                [disabled]="!form.isbn || isFetching()"
                (click)="fetchMetadata()"
              >
                {{ isFetching() ? '...' : 'Fetch' }}
              </button>
              }
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">{{
              form.type === 'audiobook' ? 'Duration' : 'Page Count'
            }}</label>
            @if (form.type === 'audiobook') {
            <input
              class="input"
              type="text"
              [(ngModel)]="form.duration"
              name="duration"
              placeholder="e.g. 12h 30m"
            />
            } @else {
            <input
              class="input"
              type="number"
              [(ngModel)]="form.pageCount"
              name="pageCount"
              placeholder="e.g. 450"
            />
            }
          </div>

          <hr class="divider" />

          @if (!isEditMode()) {
          <div class="form-group">
            <label class="form-label">Book File</label>
            <input
              type="file"
              class="file-input"
              (change)="onFileSelected($event)"
              accept=".epub,.pdf,.txt,.mobi,.mp3,.m4a,.m4b"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Cover Image</label>
            <input
              type="file"
              class="file-input"
              accept="image/*"
              (change)="onCoverSelected($event)"
            />
          </div>
          } @if (uploadProgress() !== null) {
          <div class="upload-status">Uploading... {{ uploadProgress() }}%</div>
          }
        </div>
        }

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeModal.emit()">
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="bookForm.invalid || !form.title.trim()"
          >
            {{ isEditMode() ? 'Save Changes' : 'Create Book' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
}
