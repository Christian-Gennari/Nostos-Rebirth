@if (isOpen()) {
<div class="modal-backdrop" (click)="closeModal.emit()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h2>Add New Book</h2>
      <button class="icon-btn" (click)="closeModal.emit()" title="Close">
        <lucide-icon [img]="XIcon" [size]="20"></lucide-icon>
      </button>
    </header>

    <div class="modal-body">
      <form (ngSubmit)="submitBook()" #addBookForm="ngForm">
        <div class="form-group">
          <label for="isbn" class="form-label">ISBN</label>
          <div class="flex gap-2">
            <input id="isbn" class="input flex-grow" type="text" placeholder="e.g., 978-0321765723"
              [(ngModel)]="newBook.isbn" name="isbn" />
            <button type="button" class="btn btn-secondary w-20" [disabled]="!newBook.isbn">
              Fetch
            </button>
          </div>
          <p class="text-sm text-gray-500 mt-1">
            Enter ISBN and click Fetch to auto-fill metadata.
          </p>
        </div>

        <hr class="divider" />

        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <label for="title" class="form-label">Title <span class="required">*</span></label>
            <input id="title" class="input" type="text" placeholder="Book Title" [(ngModel)]="newBook.title"
              name="title" required />
          </div>

          <div class="form-group">
            <label for="author" class="form-label">Author</label>
            <input id="author" class="input" type="text" placeholder="Author Name" [(ngModel)]="newBook.author"
              name="author" />
          </div>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <div class="form-group">
            <label for="publisher" class="form-label">Publisher</label>
            <input id="publisher" class="input" type="text" placeholder="Publisher" [(ngModel)]="newBook.publisher"
              name="publisher" />
          </div>

          <div class="form-group">
            <label for="pubDate" class="form-label">Pub. Date</label>
            <input id="pubDate" class="input" type="date" [(ngModel)]="newBook.publicationDate" name="publicationDate"
              placeholder="YYYY-MM-DD" />
          </div>

          <div class="form-group">
            <label for="pages" class="form-label">Page Count</label>
            <input id="pages" class="input" type="number" placeholder="e.g., 450" [(ngModel)]="newBook.pageCount"
              name="pageCount" />
          </div>
        </div>

        <div class="form-group">
          <label for="collection" class="form-label">Collection</label>
          <select id="collection" [(ngModel)]="newBook.collectionId" name="collectionId" class="select-input">
            <option [ngValue]="null">None</option>
            @for (col of collections(); track col.id) {
            <option [value]="col.id">{{ col.name }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label for="description" class="form-label">Description / Summary</label>
          <textarea id="description" class="input textarea" placeholder="A brief summary of the book..."
            [(ngModel)]="newBook.description" name="description" rows="4"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <label class="form-label">Book File (ePub, PDF, etc.)</label>
            <input type="file" class="file-input" (change)="onFileSelected($event)" accept=".epub,.pdf,.txt,.mobi" />
            @if (selectedFile) {
            <p class="text-sm text-gray-400 mt-1">
              File selected: **{{ selectedFile.name }}**
            </p>
            }
          </div>

          <div class="form-group">
            <label class="form-label">Cover Image</label>
            <input type="file" class="file-input" accept="image/*" (change)="onCoverSelected($event)" />
            @if (selectedCover) {
            <p class="text-sm text-gray-400 mt-1">
              Cover selected: **{{ selectedCover.name }}**
            </p>
            }
          </div>
        </div>

        @if (uploadProgress() !== null) {
        <div class="upload-status">
          <lucide-icon [img]="UploadIcon" [size]="16" class="animate-pulse"></lucide-icon>
          Uploading Book Fileâ€¦ **{{ uploadProgress() }}%**
        </div>
        }

        <div class="flex justify-end gap-3 pt-4">
          <button type="button" class="btn btn-secondary" (click)="closeModal.emit()">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="!newBook.title.trim()">
            Create Book
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
}
