@if (isOpen()) {
<div class="modal-backdrop" (click)="closeModal.emit()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h2>{{ isEditMode() ? 'Edit Metadata' : 'Add New Book' }}</h2>
      <button class="icon-btn" (click)="closeModal.emit()" title="Close">
        <lucide-icon [img]="XIcon" [size]="20"></lucide-icon>
      </button>
    </header>

    <div class="modal-body">
      <form (ngSubmit)="submit()" #bookForm="ngForm">
        <div class="form-group">
          <label class="form-label">Book Format</label>
          <select
            [(ngModel)]="form.type"
            name="type"
            class="select-input input"
            [disabled]="isEditMode()"
          >
            <option value="physical">Physical Book</option>
            <option value="ebook">E-Book</option>
            <option value="audiobook">Audiobook</option>
          </select>
        </div>

        <div class="form-group">
          <div class="input-group-fetch">
            @if (form.type === 'audiobook') {
            <input
              id="asin"
              class="input"
              type="text"
              placeholder="ASIN (e.g. B00...)"
              [(ngModel)]="form.asin"
              name="asin"
            />
            } @else {
            <input
              id="isbn"
              class="input"
              type="text"
              placeholder="e.g., 978-0321765723"
              [(ngModel)]="form.isbn"
              name="isbn"
              (keydown.enter)="$event.preventDefault(); fetchMetadata()"
            />
            <button
              type="button"
              class="btn btn-secondary btn-fetch"
              [disabled]="!form.isbn || isFetching()"
              (click)="fetchMetadata()"
            >
              @if (isFetching()) {
              <span class="dot-loader"></span>
              } @else { Fetch }
            </button>
            }
          </div>
          @if (form.type !== 'audiobook') {
          <p class="form-help-text">Enter ISBN and click Fetch to auto-fill metadata.</p>
          }
        </div>

        <hr class="divider" />

        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">Title <span class="required">*</span></label>
            <input
              class="input"
              type="text"
              placeholder="Book Title"
              [(ngModel)]="form.title"
              name="title"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label">Subtitle</label>
            <input
              class="input"
              type="text"
              placeholder="Subtitle"
              [(ngModel)]="form.subtitle"
              name="subtitle"
            />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Author</label>
          <input
            class="input"
            type="text"
            placeholder="Author Name"
            [(ngModel)]="form.author"
            name="author"
          />
        </div>

        <div class="grid grid-3">
          <div class="form-group">
            <label class="form-label">Series</label>
            <input
              class="input"
              type="text"
              placeholder="Series Name"
              [(ngModel)]="form.series"
              name="series"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Volume #</label>
            <input
              class="input"
              type="text"
              placeholder="e.g. 1"
              [(ngModel)]="form.volumeNumber"
              name="volumeNumber"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Language</label>
            <input
              class="input"
              type="text"
              placeholder="en"
              [(ngModel)]="form.language"
              name="language"
            />
          </div>
        </div>

        <div class="grid grid-3">
          <div class="form-group">
            <label class="form-label">Publisher</label>
            <input
              class="input"
              type="text"
              placeholder="Publisher"
              [(ngModel)]="form.publisher"
              name="publisher"
            />
          </div>

          <div class="form-group">
            <label class="form-label">Edition</label>
            <input
              class="input"
              type="text"
              placeholder="e.g. 2nd"
              [(ngModel)]="form.edition"
              name="edition"
            />
          </div>

          <div class="form-group">
            <div class="label-row">
              <label class="form-label">Pub. Date</label>
              <div class="info-tooltip">
                <lucide-icon [img]="InfoIcon" [size]="14"></lucide-icon>
                <span class="tooltip-text"> Formats: YYYY, YYYY-MM, or YYYY-MM-DD </span>
              </div>
            </div>

            <input
              class="input"
              type="text"
              [(ngModel)]="form.publishedDate"
              name="publishedDate"
              placeholder="e.g. 2025"
              pattern="^\d{4}(-(0[1-9]|1[0-2])(-(0[1-9]|[12]\d|3[01]))?)?$"
              #pubDateModel="ngModel"
            />

            @if (pubDateModel.invalid && (pubDateModel.dirty || pubDateModel.touched)) {
            <p class="error-text">Invalid format.</p>
            }
          </div>
        </div>

        <div class="grid grid-2">
          <div class="form-group">
            @if (form.type === 'audiobook') {
            <label class="form-label">Duration</label>
            <input
              class="input"
              type="text"
              placeholder="e.g. 12h 30m"
              [(ngModel)]="form.duration"
              name="duration"
            />
            } @else {
            <label class="form-label">Pages</label>
            <input
              class="input"
              type="number"
              placeholder="e.g. 450"
              [(ngModel)]="form.pageCount"
              name="pageCount"
            />
            }
          </div>

          <div class="form-group">
            <label class="form-label">Collection</label>
            <select [(ngModel)]="form.collectionId" name="collectionId" class="select-input input">
              <option [ngValue]="null">None</option>
              @for (col of collections(); track col.id) {
              <option [value]="col.id">{{ col.name }}</option>
              }
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Genres</label>
          <input
            class="input"
            type="text"
            placeholder="Fiction, Sci-Fi..."
            [(ngModel)]="form.categories"
            name="categories"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea
            class="input textarea"
            rows="4"
            [(ngModel)]="form.description"
            name="description"
          ></textarea>
        </div>

        @if (!isEditMode()) {
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">Book File</label>
            <input
              type="file"
              class="file-input"
              (change)="onFileSelected($event)"
              accept=".epub,.pdf,.txt,.mobi,.mp3,.m4a,.m4b"
            />
            @if (selectedFile) {
            <p class="file-status-text">
              Selected: <strong>{{ selectedFile.name }}</strong>
            </p>
            }
          </div>
          <div class="form-group">
            <label class="form-label">Cover Image</label>
            <input
              type="file"
              class="file-input"
              accept="image/*"
              (change)="onCoverSelected($event)"
            />
            @if (selectedCover) {
            <p class="file-status-text">
              Selected: <strong>{{ selectedCover.name }}</strong>
            </p>
            }
          </div>
        </div>

        @if (uploadProgress() !== null) {
        <div class="upload-status">
          <lucide-icon [img]="UploadIcon" [size]="16" class="animate-pulse"></lucide-icon>
          Uploading... <strong>{{ uploadProgress() }}%</strong>
        </div>
        } }

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeModal.emit()">
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="bookForm.invalid || !form.title.trim()"
          >
            {{ isEditMode() ? 'Save Changes' : 'Create Book' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
}
