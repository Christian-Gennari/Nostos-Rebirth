<main class="layout-wrapper" [class.sidebar-collapsed]="!sidebar.expanded()">
  @if (sidebar.expanded()) {
  <div class="mobile-backdrop" (click)="sidebar.toggle()"></div>
  }

  <app-sidebar-collections
    class="sidebar-panel"
    #sidebar
    [class.no-transition]="!sidebar.isLoaded()"
  ></app-sidebar-collections>

  <div class="library-right-side">
    <header class="toolbar">
      <h1 id="library-title">Library</h1>

      <div class="search-bar-container">
        <lucide-icon [img]="SearchIcon" [size]="18" class="search-icon"></lucide-icon>
        <input
          type="text"
          class="search-input"
          placeholder="Search books..."
          [value]="searchQuery()"
          (input)="onSearch($event)"
        />
      </div>

      <div class="toolbar-right">
        <div class="select-wrapper">
          <select [ngModel]="activeSort()" (ngModelChange)="setSort($event)" class="sort-select">
            <option value="lastread">Last Read</option>
            <option value="recent">Recently Added</option>
            <option value="title">Title (A-Z)</option>
            <option value="rating">Highest Rated</option>
          </select>
        </div>

        <div class="control-group">
          <button
            class="toggle-opt"
            [class.active]="viewMode() === 'list'"
            (click)="viewMode.set('list')"
          >
            <lucide-icon [img]="ListIcon" [size]="18" strokeWidth="1.5"></lucide-icon>
          </button>
          <button
            class="toggle-opt"
            [class.active]="viewMode() === 'grid'"
            (click)="viewMode.set('grid')"
          >
            <lucide-icon [img]="GridIcon" [size]="18" strokeWidth="1.5"></lucide-icon>
          </button>
        </div>

        <button class="btn btn-primary" (click)="openAddModal()">
          <lucide-icon [img]="PlusIcon" [size]="18"></lucide-icon>
          <span class="btn-text">Add Book</span>
        </button>
      </div>
    </header>

    <div class="container lg">
      <app-add-book-modal
        [isOpen]="showAddModal()"
        [collections]="collections()"
        (closeModal)="closeAddModal()"
        (bookAdded)="refreshBooks()"
      >
      </app-add-book-modal>

      <app-add-book-modal
        [isOpen]="showEditModal()"
        [collections]="collections()"
        [book]="editTarget()"
        (closeModal)="closeEditModal()"
        (bookUpdated)="onBookUpdated($event)"
      >
      </app-add-book-modal>

      @if (loading()) { @if (viewMode() === 'list') {
      <div class="table-view skeleton-list-view">
        <div class="table-header">
          <div id="title-header">Title</div>
          <div id="author-header">Author</div>
          <div id="rating-header">Rating</div>
          <div id="format-header">Format</div>
          <div id="date-header">Date</div>
          <div id="actions-header" style="text-align: right">Actions</div>
        </div>

        @for (i of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; track i) {
        <div class="table-row">
          <div class="col title">
            <div
              class="skeleton-line"
              [style.width]="100 - i * 5 + '%'"
              style="height: 1rem; margin-bottom: 0"
            ></div>
          </div>
          <div class="col author">
            <div
              class="skeleton-line"
              [style.width]="80 - i * 5 + '%'"
              style="height: 1rem; margin-bottom: 0"
            ></div>
          </div>
          <div class="col rating">
            <div class="skeleton-line" style="width: 50px; height: 10px; margin-bottom: 0"></div>
          </div>
          <div class="col format">
            <div class="skeleton-line" style="width: 30px; height: 10px; margin-bottom: 0"></div>
          </div>
          <div class="col date">
            <div class="skeleton-line" style="width: 40px; height: 10px; margin-bottom: 0"></div>
          </div>
          <div class="col actions-cell"></div>
        </div>
        }
      </div>
      } @if (viewMode() === 'grid') {
      <div class="book-grid skeleton-grid-view">
        @for (i of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]; track i) {
        <div class="skeleton-card">
          <div class="skeleton-box cover-size"></div>
          <div
            class="skeleton-line"
            [style.width]="70 + (i % 3) * 5 + '%'"
            style="height: 0.8rem; margin-bottom: 0.5rem"
          ></div>
          <div
            class="skeleton-line"
            [style.width]="40 + (i % 4) * 3 + '%'"
            style="height: 0.6rem; margin-bottom: 0.5rem"
          ></div>
        </div>
        }
      </div>
      } } @if (!loading()) { @if (viewMode() === 'list') {
      <div class="table-view">
        <div class="table-header">
          <div id="title-header">Title</div>
          <div id="author-header">Author</div>
          <div id="rating-header">Rating</div>
          <div id="format-header">Format</div>
          <div id="date-header">Date</div>
          <div id="actions-header" style="text-align: right">Actions</div>
        </div>

        @for (book of books(); track book.id) {
        <div class="table-row" [routerLink]="['/library', book.id]">
          <div class="col title">
            <button
              class="finished-btn-list"
              [class.active]="book.finishedAt"
              (click)="toggleFinished(book, $event)"
              [title]="book.finishedAt ? 'Mark as Unread' : 'Mark as Read'"
            >
              <lucide-icon
                [img]="CheckCircleIcon"
                [size]="16"
                [class.filled-check]="book.finishedAt"
              >
              </lucide-icon>
            </button>

            <button
              class="fav-btn-list"
              [class.active]="book.isFavorite"
              (click)="toggleFavorite(book, $event)"
              title="Toggle Favorite"
            >
              <lucide-icon [img]="HeartIcon" [size]="16" [class.filled-heart]="book.isFavorite">
              </lucide-icon>
            </button>
            {{ book.title }}
          </div>

          <div class="col author">
            {{ book.author || 'Unknown' }}
          </div>

          <div class="col rating" (click)="$event.stopPropagation()">
            @if (book.rating > 0) {
            <app-star-rating
              [rating]="book.rating"
              [size]="14"
              (ratingChange)="updateRating(book, $event)"
            >
            </app-star-rating>
            }
          </div>

          <div class="col format">
            @if (book.fileName) {
            <span class="badge">
              {{ book.fileName.substring(book.fileName.lastIndexOf('.') + 1).toUpperCase() }}
            </span>
            } @else {
            <span class="badge" style="opacity: 0.5">â€”</span>
            }
          </div>

          <div class="col date" style="color: var(--color-text-light); font-size: 0.85rem">
            {{ book.createdAt | date : 'shortDate' }}
          </div>

          <div class="col actions-cell">
            <button class="icon-btn" (click)="openEditModal(book); $event.stopPropagation()">
              <lucide-icon [img]="Edit2Icon" [size]="16"></lucide-icon>
            </button>

            <button class="icon-btn delete" (click)="deleteBook(book.id, $event)">
              <lucide-icon [img]="Trash2Icon" [size]="16"></lucide-icon>
            </button>
          </div>
        </div>
        }
      </div>
      } @if (viewMode() === 'grid') {
      <div class="book-grid">
        @for (book of books(); track book.id) {

        <div class="book-card" [routerLink]="['/library', book.id]">
          <div class="cover-wrapper">
            @if (book.coverUrl) {
            <img
              [src]="book.coverUrl"
              class="cover-image"
              alt="{{ book.title }} cover"
              loading="lazy"
              decoding="async"
            />
            } @else {
            <lucide-icon [img]="BookIcon" [size]="48" strokeWidth="1"></lucide-icon>
            }

            <button
              class="finished-btn-grid"
              [class.active]="book.finishedAt"
              (click)="toggleFinished(book, $event)"
              [title]="book.finishedAt ? 'Mark as Unread' : 'Mark as Read'"
            >
              <lucide-icon
                [img]="CheckCircleIcon"
                [size]="18"
                [class.filled-check]="book.finishedAt"
              >
              </lucide-icon>
            </button>

            <button
              class="fav-btn-grid"
              [class.active]="book.isFavorite"
              (click)="toggleFavorite(book, $event)"
              title="Toggle Favorite"
            >
              <lucide-icon [img]="HeartIcon" [size]="18" [class.filled-heart]="book.isFavorite">
              </lucide-icon>
            </button>

            <div class="actions-overlay">
              <button
                class="action-circle"
                (click)="openEditModal(book); $event.stopPropagation()"
                title="Edit"
              >
                <lucide-icon [img]="Edit2Icon" [size]="16"></lucide-icon>
              </button>

              <button
                class="action-circle delete"
                (click)="deleteBook(book.id, $event)"
                title="Delete"
              >
                <lucide-icon [img]="Trash2Icon" [size]="16"></lucide-icon>
              </button>
            </div>
          </div>

          <div class="meta-title">{{ book.title }}</div>
          <div class="meta-author">{{ book.author || 'Unknown' }}</div>

          @if (book.rating > 0) {
          <div class="meta-rating" (click)="$event.stopPropagation()">
            <app-star-rating
              [rating]="book.rating"
              [size]="14"
              (ratingChange)="updateRating(book, $event)"
            >
            </app-star-rating>
          </div>
          }
        </div>

        }
      </div>
      } @if (hasMoreBooks()) {
      <div
        appInfiniteScroll
        (scrolly)="loadMore()"
        style="
          display: flex;
          justify-content: center;
          padding: 2rem 0;
          width: 100%;
          min-height: 50px;
        "
      >
        @if (loadingMore()) {
        <lucide-icon
          [img]="LoaderIcon"
          [size]="24"
          class="spin-animation"
          color="var(--color-primary)"
        ></lucide-icon>
        }
      </div>
      } }
    </div>
  </div>
</main>
