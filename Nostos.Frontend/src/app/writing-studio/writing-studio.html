<div class="studio-layout">
  <div
    class="backdrop"
    [class.visible]="isMobile() && (showFileSidebar() || showBrainSidebar())"
    (click)="closeSidebars()"
  ></div>

  <aside class="sidebar-left" [class.open]="showFileSidebar()">
    <div class="sidebar-header">
      <h2>Studio</h2>
      <div class="actions">
        <button class="icon-btn" (click)="createItem('Folder')" title="New Folder">
          <lucide-icon [img]="Icons.FolderPlus" [size]="16"></lucide-icon>
        </button>
        <button class="icon-btn" (click)="createItem('Document')" title="New File">
          <lucide-icon [img]="Icons.Plus" [size]="16"></lucide-icon>
        </button>
        @if (isMobile()) {
        <button class="icon-btn mobile-only" (click)="showFileSidebar.set(false)">
          <lucide-icon [img]="Icons.Close" [size]="16"></lucide-icon>
        </button>
        }
      </div>
    </div>

    <div
      class="file-list"
      cdkDropList
      id="root-list"
      [cdkDropListData]="rootItems()"
      [cdkDropListConnectedTo]="connectedLists()"
      (cdkDropListDropped)="onDrop($event)"
    >
      @for (item of rootItems(); track item.id) { @if (editingId() === item.id) {
      <div class="tree-node-wrapper input-mode" style="padding: 4px 8px">
        <input
          #editInput
          type="text"
          class="title-input"
          style="width: 100%; font-size: 0.9rem; padding: 4px"
          [value]="item.name"
          (keydown.enter)="saveRename(item.id, editInput.value)"
          (keydown.escape)="cancelRename()"
          (blur)="cancelRename()"
          autoFocus
        />
      </div>
      } @else {
      <app-tree-node
        [item]="item"
        [activeId]="activeItem()?.id || null"
        [expandOnSelect]="true"
        [editable]="true"
        (nodeSelected)="handleItemSelected($event)"
        (nodeMoved)="handleItemMove($event)"
        (nodeRenamed)="startRename($event)"
        (nodeDeleted)="deleteItem($event)"
      ></app-tree-node>
      } }
    </div>
  </aside>

  <main class="editor-pane">
    @if (activeItem(); as item) {
    <div class="editor-header">
      @if (isMobile()) {
      <button
        class="icon-btn"
        (click)="showFileSidebar.set(!showFileSidebar())"
        title="Toggle Files"
      >
        <lucide-icon
          [img]="showFileSidebar() ? Icons.PanelLeftClose : Icons.PanelLeftOpen"
          [size]="20"
        ></lucide-icon>
      </button>
      }

      <input
        class="title-input"
        [ngModel]="editorTitle()"
        (ngModelChange)="editorTitle.set($event)"
        placeholder="Untitled Document"
      />

      <div class="meta-controls">
        <span class="status-badge">{{ saveStatus() }}</span>

        @if (isMobile()) {
        <button
          class="icon-btn brain-toggle"
          [class.active]="showBrainSidebar()"
          (click)="showBrainSidebar.set(!showBrainSidebar())"
          title="Toggle Brain"
        >
          <lucide-icon [img]="Icons.BrainCircuit" [size]="20"></lucide-icon>
        </button>
        }
      </div>
    </div>

    <div class="editor-wrapper">
      <app-markdown-editor
        [initialContent]="editorText()"
        (contentChange)="editorText.set($event)"
      ></app-markdown-editor>
    </div>

    } @else {
    <div class="empty-state">
      <div class="icon-circle">
        <lucide-icon
          [img]="Icons.FileText"
          [size]="32"
          color="var(--color-text-light)"
        ></lucide-icon>
      </div>
      <p>Select a file to begin writing</p>
      @if (isMobile()) {
      <button class="btn-outline" (click)="showFileSidebar.set(true)">Open Sidebar</button>
      }
    </div>
    }
  </main>

  <aside class="sidebar-right" [class.open]="showBrainSidebar()">
    <div class="sidebar-header">
      <h2>Brain Context</h2>
      @if (isMobile()) {
      <button class="icon-btn" (click)="showBrainSidebar.set(false)">
        <lucide-icon [img]="Icons.PanelRightClose" [size]="16"></lucide-icon>
      </button>
      }
    </div>

    <div class="search-box">
      <lucide-icon [img]="Icons.Search" [size]="16"></lucide-icon>
      <input
        type="text"
        placeholder="Search concepts..."
        [ngModel]="brainQuery()"
        (ngModelChange)="brainQuery.set($event)"
      />
    </div>

    <div class="brain-content">
      @if (!selectedConceptId()) {
      <div class="index-list">
        @for (c of filteredConcepts(); track c.id) {
        <button class="concept-item" (click)="selectConcept(c.id)">
          <span class="name">{{ c.name }}</span>
          <span class="badge-count">{{ c.usageCount }}</span>
        </button>
        }
      </div>
      } @else {
      <div class="brain-detail-header">
        <button class="goto-btn" (click)="selectedConceptId.set(null)">
          <lucide-icon [img]="Icons.ArrowLeft" [size]="16"></lucide-icon>
          Back to Index
        </button>
      </div>

      <div class="notes-list">
        @for (note of selectedConceptNotes(); track note.noteId) {
        <app-note-card
          [note]="note"
          (click)="insertNoteIntoEditor(note.selectedText)"
          class="clickable-note"
        ></app-note-card>
        } @if(selectedConceptNotes().length === 0) {
        <p class="empty-index">No notes found for this concept.</p>
        }
      </div>
      }
    </div>
  </aside>
</div>
