<div class="studio-layout">
  <div
    class="backdrop"
    [class.visible]="isMobile() && (showFileSidebar() || showBrainSidebar())"
    (click)="closeSidebars()"
  ></div>

  <aside class="sidebar-left" [class.open]="showFileSidebar()">
    <div class="sidebar-header">
      <h2>Studio</h2>
      <div class="actions">
        <button class="icon-btn" (click)="createItem('Folder')" title="New Folder">
          <lucide-icon [img]="Icons.FolderPlus" [size]="18"></lucide-icon>
        </button>
        <button class="icon-btn" (click)="createItem('Document')" title="New File">
          <lucide-icon [img]="Icons.Plus" [size]="18"></lucide-icon>
        </button>
        <button class="icon-btn mobile-toggle" (click)="showFileSidebar.set(false)">
          <lucide-icon [img]="Icons.Close" [size]="18"></lucide-icon>
        </button>
      </div>
    </div>

    <div
      class="file-list"
      cdkDropList
      [cdkDropListData]="rootItems()"
      [cdkDropListConnectedTo]="allDropListIds()"
      (cdkDropListDropped)="onDrop($event)"
      id="root-list"
    >
      @for (item of rootItems(); track item.id) {
      <app-file-tree-item
        [item]="item"
        [activeId]="activeItem()?.id || null"
        [connectedDropLists]="allDropListIds()"
        (itemSelected)="handleItemSelected($event)"
        (itemMoved)="handleItemMove($event)"
      ></app-file-tree-item>
      }
    </div>
  </aside>

  <main class="editor-pane">
    @if (activeItem(); as item) {
    <div class="editor-header">
      <button class="icon-btn mobile-toggle" (click)="showFileSidebar.set(true)">
        <lucide-icon [img]="Icons.Menu" [size]="20"></lucide-icon>
      </button>

      <input
        class="title-input"
        [ngModel]="editorTitle()"
        (ngModelChange)="editorTitle.set($event)"
        placeholder="Untitled"
      />

      <div class="meta-controls">
        <div class="status-badge" [class.saving]="saveStatus() === 'Saving...'">
          {{ saveStatus() }}
        </div>

        <button
          class="icon-btn brain-toggle"
          [class.active]="showBrainSidebar()"
          (click)="showBrainSidebar.set(!showBrainSidebar())"
          title="Toggle Second Brain"
        >
          <lucide-icon [img]="Icons.BrainCircuit" [size]="20"></lucide-icon>
        </button>
      </div>
    </div>

    <textarea
      class="markdown-editor"
      [ngModel]="editorText()"
      (ngModelChange)="editorText.set($event)"
      placeholder="Start writing..."
    ></textarea>

    } @else {
    <div class="empty-state">
      <button
        class="icon-btn mobile-toggle"
        (click)="showFileSidebar.set(true)"
        style="width: auto; padding: 10px; border: 1px solid var(--border-color)"
      >
        <lucide-icon [img]="Icons.Menu" [size]="20" style="margin-right: 8px"></lucide-icon>
        Open File Browser
      </button>
      <lucide-icon
        [img]="Icons.FileText"
        [size]="48"
        color="var(--color-text-light)"
        strokeWidth="1"
      ></lucide-icon>
      <p>Select a file to start writing</p>
    </div>
    }
  </main>

  <aside class="sidebar-right" [class.open]="showBrainSidebar()">
    <div class="sidebar-header">
      <h2>Brain</h2>
      <button class="icon-btn" (click)="showBrainSidebar.set(false)">
        <lucide-icon [img]="Icons.Close" [size]="18"></lucide-icon>
      </button>
    </div>

    <div class="search-box">
      <lucide-icon [img]="Icons.Search" [size]="16" color="var(--color-text-muted)"></lucide-icon>
      <input
        type="text"
        placeholder="Search concepts..."
        [ngModel]="brainQuery()"
        (ngModelChange)="brainQuery.set($event)"
      />
    </div>

    <div class="brain-content">
      @if (!selectedConceptId()) {
      <div class="concept-list">
        @for (c of filteredConcepts; track c.id) {
        <div class="concept-item" (click)="selectConcept(c.id)">
          <span>{{ c.name }}</span>
          <span class="badge-count">{{ c.usageCount }}</span>
        </div>
        }
      </div>
      } @else {
      <button class="back-btn" (click)="selectedConceptId.set(null)">‚Üê Back to Index</button>

      <div class="notes-list">
        @for (note of selectedConceptNotes(); track note.noteId) {
        <app-note-card
          [note]="note"
          (click)="insertNoteIntoEditor(note.selectedText)"
        ></app-note-card>
        } @if(selectedConceptNotes().length === 0) {
        <p
          class="empty-msg"
          style="padding: 1rem; color: var(--color-text-light); text-align: center"
        >
          No notes linked to this concept.
        </p>
        }
      </div>
      }
    </div>
  </aside>
</div>
