<div class="note-card-container" [class.editing]="isEditing">
  @if (isEditing) {

  <div class="edit-box" (click)="$event.stopPropagation()">
    @if (note.selectedText || editSelectedText) {
    <textarea
      class="edit-quote-input"
      [(ngModel)]="editSelectedText"
      placeholder="Quote text..."
      rows="2"
    ></textarea>
    }

    <app-concept-input
      [(ngModel)]="editContent"
      [rows]="3"
      (submitTrigger)="saveEdit()"
    ></app-concept-input>

    <div class="edit-actions">
      <button class="icon-btn small" (click)="saveEdit($event)" title="Save">
        <lucide-icon [img]="Icons.Check" [size]="16"></lucide-icon>
      </button>
      <button class="icon-btn small" (click)="cancelEdit($event)" title="Cancel">
        <lucide-icon [img]="Icons.Close" [size]="16"></lucide-icon>
      </button>
    </div>
  </div>

  } @else {

  <div class="content-row">
    <div class="collapsible-body" [class.collapsed]="shouldShowExpandBtn && !isExpanded">
      @if (note.selectedText) {
      <div class="note-quote">
        <div class="quote-stripe"></div>
        <lucide-icon [img]="Icons.MessageSquareQuote" [size]="14" class="quote-icon"></lucide-icon>
        <p class="quote-text">"{{ note.selectedText }}"</p>
      </div>
      } @if (note.content) {
      <p
        class="note-text"
        [innerHTML]="note.content | noteFormat : conceptMap"
        (click)="onContentClick($event)"
      ></p>
      } @else {
      <p class="note-meta-placeholder">No additional comment</p>
      }
    </div>

    @if (shouldShowExpandBtn) {
    <button class="expand-btn" (click)="toggleExpand($event)">
      <span>{{ isExpanded ? 'Show less' : 'Show more' }}</span>
      <lucide-icon
        [img]="isExpanded ? Icons.ChevronUp : Icons.ChevronDown"
        [size]="12"
      ></lucide-icon>
    </button>
    }

    <div class="note-footer">
      <div class="note-metadata">
        @if (showDate && note.createdAt) {
        <span class="note-date">{{ note.createdAt | date : 'short' }}</span>
        } @if (showSource && note.bookTitle) { @if (showDate && note.createdAt) {
        <span class="meta-separator">â€¢</span>
        }

        <a
          class="source-badge"
          [routerLink]="['/library', note.bookId]"
          [queryParams]="{ cfi: note.cfiRange }"
          (click)="$event.stopPropagation()"
          title="Go to: {{ note.bookTitle }}"
        >
          <lucide-icon [img]="Icons.Library" [size]="12"></lucide-icon>
          <span>{{ note.bookTitle }}</span>
        </a>
        }
      </div>

      @if (showNavigation || showActions) {
      <div class="note-actions">
        @if (showNavigation) {
        <button class="icon-btn xs" (click)="onCardClick($event)" title="Jump to location">
          <lucide-icon [img]="Icons.ArrowRight" [size]="14"></lucide-icon>
        </button>
        } @if (showActions) {
        <button class="icon-btn xs" (click)="startEdit($event)">
          <lucide-icon [img]="Icons.Edit" [size]="14"></lucide-icon>
        </button>
        <button class="icon-btn xs delete" (click)="onDelete($event)">
          <lucide-icon [img]="Icons.Delete" [size]="14"></lucide-icon>
        </button>
        }
      </div>
      }
    </div>
  </div>
  }
</div>
