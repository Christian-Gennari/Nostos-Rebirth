<div
  class="tree-node-wrapper"
  cdkDrag
  [cdkDragData]="item"
  [cdkDragDisabled]="!isFolder() && !editable"
>
  <div *cdkDragPreview class="drag-preview">
    <lucide-icon [img]="isFolder() ? Icons.Folder : Icons.FileText" [size]="16"></lucide-icon>
    {{ item.name }}
  </div>

  <div
    class="node-row"
    [class.active]="activeId === item.id"
    [style.padding-left.px]="level * 12 + 8"
    (click)="handleSelect($event)"
  >
    <div class="drag-handle" cdkDragHandle (click)="$event.stopPropagation()">
      <lucide-icon [img]="Icons.GripVertical" [size]="14"></lucide-icon>
    </div>

    <div class="toggle-icon" (click)="toggleExpand($event)">
      @if (isFolder()) { @if (expanded()) {
      <lucide-icon [img]="Icons.ChevronDown" [size]="14"></lucide-icon>
      } @else {
      <lucide-icon [img]="Icons.ChevronRight" [size]="14"></lucide-icon>
      } }
    </div>

    <div class="type-icon">
      @if (isFolder()) {
      <lucide-icon
        [img]="expanded() ? Icons.FolderOpen : Icons.Folder"
        [size]="16"
        class="folder-icon"
      ></lucide-icon>
      } @else {
      <lucide-icon [img]="Icons.FileText" [size]="16" class="file-icon"></lucide-icon>
      }
    </div>

    <span class="node-name">{{ item.name }}</span>

    @if (editable) {
    <div class="node-actions" (click)="$event.stopPropagation()">
      <button class="action-mini" (click)="nodeRenamed.emit(item)">
        <lucide-icon [img]="Icons.Edit2" [size]="12"></lucide-icon>
      </button>
      <button class="action-mini danger" (click)="nodeDeleted.emit(item.id)">
        <lucide-icon [img]="Icons.Trash2" [size]="12"></lucide-icon>
      </button>
    </div>
    }
  </div>

  @if (isFolder() && expanded()) {
  <div
    class="node-children"
    cdkDropList
    [id]="'folder-' + item.id"
    [cdkDropListData]="item.children"
    [cdkDropListConnectedTo]="connectedDropLists"
    (cdkDropListDropped)="onDrop($event)"
  >
    @for (child of item.children; track child.id) {
    <app-tree-node
      [item]="child"
      [level]="level + 1"
      [activeId]="activeId"
      [connectedDropLists]="connectedDropLists"
      [editable]="editable"
      [expandOnSelect]="expandOnSelect"
      (nodeSelected)="onChildSelected($event)"
      (nodeMoved)="onChildMoved($event)"
      (nodeRenamed)="onChildRenamed($event)"
      (nodeDeleted)="onChildDeleted($event)"
    ></app-tree-node>
    } @if(item.children.length === 0) {
    <div class="empty-drop-zone">
      {{ editable ? 'Drop items here...' : 'Empty' }}
    </div>
    }
  </div>
  }
</div>
